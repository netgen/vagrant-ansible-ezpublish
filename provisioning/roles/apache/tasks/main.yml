---

- name: Add apache repository ondrej
  # Add specified repository into sources list.
  apt_repository: repo='ppa:ondrej/apache2/ubuntu trusty main' state=present update_cache=yes
  when: ansible_os_family == "Debian" and ansible_distribution_version|float >= 12.10
  tags: [php, php56, packages]

- name: Install Apache packages
  apt: name="{{ item }}" state=present update_cache=yes
  with_items: "{{ apache_packages }}"
  when: ansible_os_family == "Debian"
  tags: [apache2, packages]

- name: Apache should run under vagrant user
  lineinfile: dest=/etc/apache2/envvars regexp="^export APACHE_RUN_USER=www-data" line="export APACHE_RUN_USER=vagrant"

- name: Apache should run under vagrant group
  lineinfile: dest=/etc/apache2/envvars regexp="^export APACHE_RUN_GROUP=www-data" line="export APACHE_RUN_GROUP=vagrant"

- name: Own the apache logs
  file: state=directory group=vagrant owner=vagrant recurse=yes path=/var/log/apache2

- name: Own the apache lock
  file: state=directory group=vagrant owner=vagrant recurse=yes path=/var/lock/apache2

- name: Own the apache fastcgi
  file: state=directory group=vagrant owner=vagrant recurse=yes path=/var/lib/apache2/fastcgi

- name: enable Apache2 modules
  apache2_module: state=present name="{{ item }}"
  with_items: "{{ common_modules }}"
  notify: restart Apache
  when: ansible_os_family == "Debian"
  tags: [apache2]

- name: ensure Apache service is stopped (and disable it at boot)
  action: service name=apache2 state=stopped enabled=no
  tags: [apache2]

- name: configure mpm prefork
  copy: src=mpm_prefork.conf dest=/etc/apache2/mods-available/mpm_prefork.conf owner=root group=root mode=0644
  notify: restart Apache
  when: ansible_os_family == "Debian"
  tags: [apache2]

- name: configure security settings
  copy: src=security.conf dest=/etc/apache2/conf-available/security.conf owner=root group=root mode=0644
  notify: restart Apache
  when: ansible_os_family == "Debian"
  tags: [apache2]

- name: make sure that there is no default website
  file: path="{{ APACHE_SITES_ENABLED_CONFIG_PATH }}/000-default.conf" state=absent
  notify:
  - reload Apache
  tags: [apache2]

- name: "installing website config (.htaccess variant) {{ PROJECT_NAME }}"
  template: src=site_htaccess.j2 dest="{{ APACHE_SITES_AVAILABLE_CONFIG_PATH }}/{{ PROJECT_NAME }}.conf"
  notify:
  - reload Apache
  when: use_htaccess == true
  tags: [apache2]

- name: "installing website config (virtual host variant) {{ PROJECT_NAME }}"
  template: src=site_vhost.j2 dest="{{ APACHE_SITES_AVAILABLE_CONFIG_PATH }}/{{ PROJECT_NAME }}.conf"
  notify:
  - reload Apache
  when: use_htaccess == false
  tags: [apache2]

- name: "create a symlink for website {{ PROJECT_NAME }}"
  file: src="{{ APACHE_SITES_AVAILABLE_CONFIG_PATH }}/{{ PROJECT_NAME }}.conf" dest="{{ APACHE_SITES_ENABLED_CONFIG_PATH }}/{{ PROJECT_NAME }}.conf" state=link
  # also a handler named restart APACHE is present if needed
  notify:
  - reload Apache
  tags: [apache2]
